<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probability Lab: List 3</title>
    
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            /* Dark Theme Palette */
            --primary: #8b5cf6; /* Violet for List 3 */
            --primary-hover: #7c3aed;
            --bg: #111827; 
            --card-bg: #1f2937; 
            --text: #f3f4f6; 
            --text-muted: #9ca3af;
            --border: #374151;
            --canvas-bg: #111827;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        header {
            background: #111827;
            border-bottom: 1px solid var(--border);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 1.5rem; color: var(--text); }
        p.subtitle { margin: 5px 0 0; color: var(--text-muted); font-size: 0.9rem; }

        .lang-switch {
            display: flex;
            gap: 5px;
            background: var(--border);
            padding: 4px;
            border-radius: 6px;
        }
        
        .lang-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .lang-btn.active { background: var(--primary); color: white; }

        .tabs {
            display: flex;
            background: #111827;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
            border: none;
            background: none;
            border-bottom: 3px solid transparent;
        }
        .tab:hover { color: var(--text); background-color: rgba(255,255,255,0.05); }
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background-color: var(--card-bg);
        }

        .section { display: none; padding: 20px; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        button.action-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        button.action-btn:hover { background-color: var(--primary-hover); }
        button.secondary { background-color: var(--border); color: var(--text); }
        button.secondary:hover { background-color: #4b5563; }

        .canvas-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        canvas {
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--canvas-bg);
            max-width: 100%;
        }

        .description {
            margin-bottom: 20px;
            line-height: 1.6;
            color: var(--text);
            background: rgba(139, 92, 246, 0.1); /* Violet tint */
            padding: 15px;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .stat-box {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); font-family: monospace; }
        .stat-lbl { font-size: 0.8rem; color: var(--text-muted); }

        /* Correlation Table Inputs */
        .matrix-input {
            display: grid;
            grid-template-columns: 80px 80px 80px;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .matrix-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .matrix-cell input {
            width: 60px;
            padding: 5px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: white;
            text-align: center;
            border-radius: 4px;
        }
        .matrix-cell label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-content">
            <h1 data-key="title">Distribution Parameters Lab</h1>
            <p class="subtitle" data-key="subtitle">List 3: Expected Value, Variance, and Correlation</p>
        </div>
        <div class="lang-switch">
            <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
            <button class="lang-btn" onclick="setLanguage('pl')">PL</button>
        </div>
    </header>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('moments')" data-key="tabMoments">1. Center of Mass (Mean)</button>
        <button class="tab" onclick="switchTab('gambling')" data-key="tabGambling">2. Gambling (Law of Large Numbers)</button>
        <button class="tab" onclick="switchTab('correlation')" data-key="tabCorrelation">3. Correlation Maker</button>
    </div>

    <!-- SEKCJA 1: MOMENTY (ŚRODEK CIĘŻKOŚCI) -->
    <div id="moments" class="section active">
        <div class="description" data-key="descMoments">
            <strong>Concept:</strong> The Expected Value $E(X)$ behaves like the center of mass (fulcrum) of the distribution. Variance $D^2(X)$ is the moment of inertia (spread). 
            <br>Click on the bars below to change the probability mass distribution and see how the balance point moves. (Based on Task 1).
        </div>

        <div class="controls">
            <button class="action-btn secondary" onclick="resetMoments()" data-key="btnReset">Reset Distribution</button>
        </div>

        <div class="canvas-container">
            <canvas id="momentsCanvas" width="600" height="300"></canvas>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div id="valMean" class="stat-val">0.00</div>
                <div class="stat-lbl" data-key="statMean">Expected Value E(X)</div>
            </div>
            <div class="stat-box">
                <div id="valVar" class="stat-val">0.00</div>
                <div class="stat-lbl" data-key="statVar">Variance D²(X)</div>
            </div>
            <div class="stat-box">
                <div id="valStd" class="stat-val">0.00</div>
                <div class="stat-lbl" data-key="statStd">Std Dev σ(X)</div>
            </div>
        </div>
    </div>

    <!-- SEKCJA 2: GRA HAZARDOWA -->
    <div id="gambling" class="section">
        <div class="description" data-key="descGambling">
            <strong>Task 3:</strong> Die roll. 
            <br>Roll 6: Win 10 PLN. Roll 4,5: Win 2 PLN. Else: 0 PLN. 
            <br>Entry Cost: 2 PLN.
            <br>Is this game fair? $E(\text{Net}) \approx +0.33$ PLN. Simulate it to see the long-term trend.
        </div>

        <div class="controls">
            <button class="action-btn" onclick="gamble(1)" data-key="btnPlay1">Play 1 Round</button>
            <button class="action-btn" onclick="gamble(100)" data-key="btnPlay100">Play 100 Rounds</button>
            <button class="action-btn" onclick="gamble(1000)" data-key="btnPlay1000">Play 1000 Rounds</button>
            <button class="action-btn secondary" onclick="resetGambling()" data-key="btnReset">Reset Wallet</button>
        </div>

        <div class="canvas-container">
            <canvas id="gamblingCanvas" width="600" height="300"></canvas>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div id="gameCount" class="stat-val">0</div>
                <div class="stat-lbl" data-key="statGames">Games Played</div>
            </div>
            <div class="stat-box">
                <div id="gameBalance" class="stat-val">0</div>
                <div class="stat-lbl" data-key="statBalance">Wallet Balance (PLN)</div>
            </div>
            <div class="stat-box">
                <div id="gameAvg" class="stat-val">0.00</div>
                <div class="stat-lbl" data-key="statAvgWin">Avg Net Profit/Game</div>
            </div>
        </div>
    </div>

    <!-- SEKCJA 3: KORELACJA -->
    <div id="correlation" class="section">
        <div class="description" data-key="descCorrelation">
            <strong>Correlation Explorer:</strong> (Task 7 & 8). Adjust the probabilities in the joint table below.
            <br>Observe how placing probability mass on the diagonal makes Correlation $\rho \to 1$, and on the anti-diagonal $\rho \to -1$.
        </div>

        <div class="matrix-input">
            <!-- Headers -->
            <div></div>
            <div style="text-align:center; color:var(--text-muted)">Y=2</div>
            <div style="text-align:center; color:var(--text-muted)">Y=5</div>

            <!-- Row 1 -->
            <div style="text-align:right; padding-right:10px; color:var(--text-muted); align-self:center;">X=1</div>
            <div class="matrix-cell">
                <input type="number" id="p11" value="0.2" step="0.1" min="0" max="1" onchange="updateCorr()">
            </div>
            <div class="matrix-cell">
                <input type="number" id="p12" value="0.3" step="0.1" min="0" max="1" onchange="updateCorr()">
            </div>

            <!-- Row 2 -->
            <div style="text-align:right; padding-right:10px; color:var(--text-muted); align-self:center;">X=3</div>
            <div class="matrix-cell">
                <input type="number" id="p21" value="0.4" step="0.1" min="0" max="1" onchange="updateCorr()">
            </div>
            <div class="matrix-cell">
                <input type="number" id="p22" value="0.1" step="0.1" min="0" max="1" onchange="updateCorr()">
            </div>
        </div>

        <div class="controls">
            <button class="action-btn" onclick="presetCorr('pos')" data-key="btnPosCorr">Pos. Correlation</button>
            <button class="action-btn" onclick="presetCorr('neg')" data-key="btnNegCorr">Neg. Correlation</button>
            <button class="action-btn" onclick="presetCorr('zero')" data-key="btnZeroCorr">No Correlation</button>
        </div>
        
        <p id="sumWarning" style="color:#ef4444; text-align:center; display:none;" data-key="warningSum">Sum of probabilities must be 1.0!</p>

        <div class="canvas-container">
            <canvas id="corrCanvas" width="400" height="300"></canvas>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div id="resCov" class="stat-val">0.00</div>
                <div class="stat-lbl">Covariance Cov(X,Y)</div>
            </div>
            <div class="stat-box">
                <div id="resRho" class="stat-val">0.00</div>
                <div class="stat-lbl">Correlation ρ(X,Y)</div>
            </div>
        </div>
    </div>

</div>

<script>
    const translations = {
        en: {
            title: "Distribution Parameters Lab",
            subtitle: "List 3: Expected Value, Variance, and Correlation",
            tabMoments: "1. Center of Mass (Mean)",
            tabGambling: "2. Gambling (Law of Large Numbers)",
            tabCorrelation: "3. Correlation Maker",
            descMoments: "<strong>Concept:</strong> The Expected Value $E(X)$ behaves like the center of mass (fulcrum) of the distribution. Variance $D^2(X)$ is the moment of inertia (spread). <br>Click on the bars below to change the probability mass distribution and see how the balance point moves.",
            btnReset: "Reset",
            statMean: "Expected Value E(X)",
            statVar: "Variance D²(X)",
            statStd: "Std Dev σ(X)",
            descGambling: "<strong>Task 3:</strong> Die roll.<br>Roll 6: Win 10 PLN. Roll 4,5: Win 2 PLN. Else: 0 PLN.<br>Entry Cost: 2 PLN.<br>Is this game fair? $E(\\text{Net}) \\approx +0.33$ PLN. Simulate it to see the long-term trend.",
            btnPlay1: "Play 1 Round",
            btnPlay100: "Play 100 Rounds",
            btnPlay1000: "Play 1000 Rounds",
            statGames: "Games Played",
            statBalance: "Wallet Balance (PLN)",
            statAvgWin: "Avg Net Profit/Game",
            descCorrelation: "<strong>Correlation Explorer:</strong> (Task 7 & 8). Adjust the probabilities in the joint table below.<br>Observe how placing probability mass on the diagonal makes Correlation $\\rho \\to 1$, and on the anti-diagonal $\\rho \\to -1$.",
            btnPosCorr: "Pos. Correlation",
            btnNegCorr: "Neg. Correlation",
            btnZeroCorr: "No Correlation",
            warningSum: "Sum of probabilities must be 1.0!",
            // Canvas
            lblProb: "Probability",
            lblValue: "Value",
            lblWallet: "Wallet (PLN)",
            lblGames: "Games"
        },
        pl: {
            title: "Laboratorium Parametrów",
            subtitle: "Lista 3: Wartość Oczekiwana, Wariancja i Korelacja",
            tabMoments: "1. Środek Ciężkości (Średnia)",
            tabGambling: "2. Gra Hazardowa (Prawo Wielkich Liczb)",
            tabCorrelation: "3. Kreator Korelacji",
            descMoments: "<strong>Koncepcja:</strong> Wartość Oczekiwana $E(X)$ zachowuje się jak środek ciężkości (punkt podparcia). Wariancja $D^2(X)$ to moment bezwładności (rozrzut). <br>Klikaj w słupki, aby zmienić rozkład masy prawdopodobieństwa i zobacz, jak przesuwa się punkt równowagi.",
            btnReset: "Resetuj",
            statMean: "Wartość Oczekiwana E(X)",
            statVar: "Wariancja D²(X)",
            statStd: "Odchylenie Std σ(X)",
            descGambling: "<strong>Zadanie 3:</strong> Rzut kostką.<br>Szóstka: Wygrana 10 zł. 4 lub 5: Wygrana 2 zł. Inne: 0 zł.<br>Koszt gry: 2 zł.<br>Czy gra jest sprawiedliwa? $E(\\text{Net}) \\approx +0.33$ zł. Symuluj, aby zobaczyć trend długoterminowy.",
            btnPlay1: "Graj 1 raz",
            btnPlay100: "Graj 100 razy",
            btnPlay1000: "Graj 1000 razy",
            statGames: "Rozegrane gry",
            statBalance: "Stan portfela (PLN)",
            statAvgWin: "Śr. zysk na grę",
            descCorrelation: "<strong>Badanie Korelacji:</strong> (Zadanie 7 i 8). Zmieniaj prawdopodobieństwa w tabeli poniżej.<br>Obserwuj: masa na głównej przekątnej daje $\\rho \\to 1$, a na przeciwprostokątnej $\\rho \\to -1$.",
            btnPosCorr: "Korelacja Dodatnia",
            btnNegCorr: "Korelacja Ujemna",
            btnZeroCorr: "Brak Korelacji",
            warningSum: "Suma prawdopodobieństw musi wynosić 1.0!",
            // Canvas
            lblProb: "Prawdopodobieństwo",
            lblValue: "Wartość",
            lblWallet: "Portfel (PLN)",
            lblGames: "Gry"
        }
    };

    let currentLang = 'en';
    function setLanguage(lang) {
        currentLang = lang;
        const t = translations[lang];
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if(t[key]) el.innerHTML = t[key];
        });
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtnIndex = lang === 'en' ? 0 : 1;
        document.querySelectorAll('.lang-btn')[activeBtnIndex].classList.add('active');

        if (window.MathJax && window.MathJax.typesetPromise) window.MathJax.typesetPromise();

        if(document.getElementById('moments').classList.contains('active')) drawMoments();
        if(document.getElementById('gambling').classList.contains('active')) drawGambling();
        if(document.getElementById('correlation').classList.contains('active')) updateCorr();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        const tabs = ['moments', 'gambling', 'correlation'];
        document.querySelectorAll('.tab')[tabs.indexOf(tabId)].classList.add('active');
        document.getElementById(tabId).classList.add('active');

        if(tabId === 'moments') drawMoments();
        if(tabId === 'gambling') drawGambling();
        if(tabId === 'correlation') updateCorr();
    }

    // --- MODULE 1: MOMENTS ---
    // Task 1 Values: -2, 0, 2, 4
    const xVals = [-2, 0, 2, 4];
    let probs = [0.1, 0.4, 0.3, 0.2]; // Sum = 1.0

    function resetMoments() {
        probs = [0.1, 0.4, 0.3, 0.2];
        drawMoments();
    }

    function drawMoments() {
        const canvas = document.getElementById('momentsCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const t = translations[currentLang];

        ctx.clearRect(0, 0, w, h);

        // Calc stats
        let mean = 0;
        let sumP = 0;
        for(let i=0; i<4; i++) { mean += xVals[i] * probs[i]; sumP += probs[i]; }
        // Normalize if user messed up (visual only)
        // But here user clicks to increment, logic below ensures normalization approx
        
        let variance = 0;
        for(let i=0; i<4; i++) { variance += probs[i] * Math.pow(xVals[i] - mean, 2); }
        let std = Math.sqrt(variance);

        // Update DOM
        document.getElementById('valMean').textContent = mean.toFixed(2);
        document.getElementById('valVar').textContent = variance.toFixed(2);
        document.getElementById('valStd').textContent = std.toFixed(2);

        // Draw
        const margin = 50;
        const chartH = h - 100;
        const barW = 60;
        const scaleX = (w - 2*margin) / 7; // range -2 to 4 is size 6. + padding
        // Mapping X value to Canvas X
        // Range -3 to 5 to give space
        const mapX = (val) => margin + (val + 3) * scaleX;
        
        // Axis
        ctx.strokeStyle = "#4b5563";
        ctx.beginPath(); ctx.moveTo(margin, chartH); ctx.lineTo(w-margin, chartH); ctx.stroke();

        // Draw Bars
        xVals.forEach((val, i) => {
            const bx = mapX(val);
            const bh = probs[i] * 400; // Scale height
            
            ctx.fillStyle = "#8b5cf6";
            ctx.fillRect(bx - barW/2, chartH - bh, barW, bh);
            
            // Label Value
            ctx.fillStyle = "#fff";
            ctx.textAlign = "center";
            ctx.font = "14px monospace";
            ctx.fillText(val, bx, chartH + 20);

            // Label Prob
            ctx.fillStyle = "#c4b5fd";
            ctx.font = "12px sans-serif";
            ctx.fillText(probs[i].toFixed(2), bx, chartH - bh - 5);
        });

        // Draw Fulcrum (Mean)
        const fulcrumX = mapX(mean);
        ctx.fillStyle = "#10b981"; // Green
        ctx.beginPath();
        ctx.moveTo(fulcrumX, chartH);
        ctx.lineTo(fulcrumX - 10, chartH + 15);
        ctx.lineTo(fulcrumX + 10, chartH + 15);
        ctx.fill();
        ctx.fillText("E(X)", fulcrumX, chartH + 30);

        // Draw Std Dev range
        const stdY = chartH - 200; // arbitrary height
        ctx.strokeStyle = "#f59e0b"; // Orange
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(mapX(mean - std), stdY);
        ctx.lineTo(mapX(mean + std), stdY);
        ctx.stroke();
        // Ticks
        ctx.beginPath(); ctx.moveTo(mapX(mean - std), stdY-5); ctx.lineTo(mapX(mean - std), stdY+5); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(mapX(mean + std), stdY-5); ctx.lineTo(mapX(mean + std), stdY+5); ctx.stroke();
        
        ctx.fillStyle = "#f59e0b";
        ctx.fillText("±σ", mapX(mean), stdY - 5);
        
        // Label Axis
        ctx.fillStyle = "#9ca3af";
        ctx.fillText(t.lblValue, w/2, h - 10);
    }

    // Interaction: Click to modify prob
    document.getElementById('momentsCanvas').addEventListener('click', function(e) {
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const w = this.width;
        const margin = 50;
        const scaleX = (w - 2*margin) / 7;
        const mapX = (val) => margin + (val + 3) * scaleX;
        
        // Check which bar clicked
        xVals.forEach((val, i) => {
            const bx = mapX(val);
            if(Math.abs(x - bx) < 30) {
                // Cycle probability: +0.1, wrap at 0.5
                probs[i] += 0.1;
                if(probs[i] > 0.55) probs[i] = 0.0;
                
                // Renormalize others
                let currentSum = probs.reduce((a,b)=>a+b,0);
                if(currentSum === 0) { probs[i] = 1.0; } // prevent zero sum
                else {
                    // Normalize
                    for(let k=0; k<4; k++) probs[k] = probs[k] / currentSum;
                }
                drawMoments();
            }
        });
    });


    // --- MODULE 2: GAMBLING ---
    let walletHistory = [0];
    let gamesPlayed = 0;
    
    function resetGambling() {
        walletHistory = [0];
        gamesPlayed = 0;
        drawGambling();
    }

    function gamble(n) {
        let currentBalance = walletHistory[walletHistory.length-1];
        
        for(let i=0; i<n; i++) {
            // Cost
            currentBalance -= 2;
            
            // Roll
            const r = Math.floor(Math.random() * 6) + 1;
            if(r === 6) currentBalance += 10;
            else if(r === 4 || r === 5) currentBalance += 2;
            
            walletHistory.push(currentBalance);
            gamesPlayed++;
        }
        
        // Trim history for performance if too long
        if(walletHistory.length > 2000) {
            // Keep start, some middle, and end? Or just shift
            // Let's just keep last 2000 for visuals
             const cut = walletHistory.length - 2000;
             walletHistory = walletHistory.slice(cut);
             // Note: gamesPlayed keeps counting correctly
        }

        drawGambling();
    }

    function drawGambling() {
        const canvas = document.getElementById('gamblingCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const t = translations[currentLang];
        
        ctx.clearRect(0, 0, w, h);

        const currentBalance = walletHistory[walletHistory.length-1];
        const avg = gamesPlayed > 0 ? currentBalance / gamesPlayed : 0;

        document.getElementById('gameCount').textContent = gamesPlayed;
        document.getElementById('gameBalance').textContent = currentBalance;
        document.getElementById('gameAvg').textContent = avg.toFixed(3); // Should converge to +0.333

        // Plot
        if(walletHistory.length < 2) return;

        const maxVal = Math.max(...walletHistory, 10);
        const minVal = Math.min(...walletHistory, -10);
        const rangeY = maxVal - minVal;
        
        const scaleX = w / (walletHistory.length - 1);
        const scaleY = (h - 40) / rangeY;
        
        // Zero line Y
        const zeroY = h - 20 - (0 - minVal) * scaleY;

        // Draw Zero Line
        ctx.strokeStyle = "#4b5563";
        ctx.beginPath(); ctx.moveTo(0, zeroY); ctx.lineTo(w, zeroY); ctx.stroke();
        ctx.fillStyle = "#9ca3af"; ctx.fillText("0 PLN", 5, zeroY - 5);

        // Draw Graph
        ctx.beginPath();
        ctx.strokeStyle = avg >= 0 ? "#10b981" : "#ef4444";
        ctx.lineWidth = 2;
        
        walletHistory.forEach((val, i) => {
            const x = i * scaleX;
            const y = h - 20 - (val - minVal) * scaleY;
            if(i===0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Theoretical Slope Line (Expected Value)
        // y = 0.333 * x
        // Start at 0,0 (relative to history window? No, simplified)
        // Just showing the actual graph is enough for intuition.
    }


    // --- MODULE 3: CORRELATION ---
    // Task 7 Data structure: X={1,3}, Y={2,5}
    // p11 (X=1,Y=2), p12 (X=1,Y=5)
    // p21 (X=3,Y=2), p22 (X=3,Y=5)
    
    function presetCorr(type) {
        if(type === 'pos') {
            document.getElementById('p11').value = 0.4; // 1,2 (Small, Small)
            document.getElementById('p12').value = 0.1;
            document.getElementById('p21').value = 0.1;
            document.getElementById('p22').value = 0.4; // 3,5 (Big, Big)
        } else if(type === 'neg') {
            document.getElementById('p11').value = 0.1;
            document.getElementById('p12').value = 0.4; // 1,5 (Small, Big)
            document.getElementById('p21').value = 0.4; // 3,2 (Big, Small)
            document.getElementById('p22').value = 0.1;
        } else {
            document.getElementById('p11').value = 0.25;
            document.getElementById('p12').value = 0.25;
            document.getElementById('p21').value = 0.25;
            document.getElementById('p22').value = 0.25;
        }
        updateCorr();
    }

    function updateCorr() {
        const p11 = parseFloat(document.getElementById('p11').value) || 0;
        const p12 = parseFloat(document.getElementById('p12').value) || 0;
        const p21 = parseFloat(document.getElementById('p21').value) || 0;
        const p22 = parseFloat(document.getElementById('p22').value) || 0;

        const sum = p11 + p12 + p21 + p22;
        const warning = document.getElementById('sumWarning');
        
        if(Math.abs(sum - 1.0) > 0.01) {
            warning.style.display = 'block';
            warning.textContent = `Sum = ${sum.toFixed(2)} (Must be 1.0)`;
        } else {
            warning.style.display = 'none';
        }

        // Values
        const X = [1, 3];
        const Y = [2, 5];
        // Joint matrix P[i][j] where i is index of X, j index of Y
        const P = [[p11, p12], [p21, p22]];

        // Marginals
        const pX = [p11+p12, p21+p22];
        const pY = [p11+p21, p12+p22];

        // E(X), E(Y)
        const EX = X[0]*pX[0] + X[1]*pX[1];
        const EY = Y[0]*pY[0] + Y[1]*pY[1];

        // E(XY)
        let EXY = 0;
        for(let i=0; i<2; i++) {
            for(let j=0; j<2; j++) {
                EXY += X[i] * Y[j] * P[i][j];
            }
        }

        // Cov
        const cov = EXY - EX*EY;

        // Var
        const VarX = (Math.pow(X[0]-EX, 2)*pX[0]) + (Math.pow(X[1]-EX, 2)*pX[1]);
        const VarY = (Math.pow(Y[0]-EY, 2)*pY[0]) + (Math.pow(Y[1]-EY, 2)*pY[1]);
        
        const sigmaX = Math.sqrt(VarX);
        const sigmaY = Math.sqrt(VarY);

        let rho = 0;
        if(sigmaX > 0 && sigmaY > 0) rho = cov / (sigmaX * sigmaY);

        document.getElementById('resCov').textContent = cov.toFixed(3);
        document.getElementById('resRho').textContent = rho.toFixed(3);

        drawCorrViz(P, rho);
    }

    function drawCorrViz(P, rho) {
        const canvas = document.getElementById('corrCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0,0,w,h);

        // Visualize correlation as 2x2 blobs
        // X on vertical (rows), Y on horizontal (cols) to match matrix input layout visually?
        // Input layout: Rows are X (1, 3), Cols are Y (2, 5)
        
        const pad = 40;
        const cellW = (w - 2*pad) / 2;
        const cellH = (h - 2*pad) / 2;

        // Axis Labels
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.fillText("Y=2", pad + cellW/2, 20);
        ctx.fillText("Y=5", pad + 1.5*cellW, 20);
        
        ctx.textAlign = "right";
        ctx.fillText("X=1", 30, pad + cellH/2);
        ctx.fillText("X=3", 30, pad + 1.5*cellH);

        for(let i=0; i<2; i++) { // Rows (X)
            for(let j=0; j<2; j++) { // Cols (Y)
                const prob = P[i][j];
                const cx = pad + j*cellW + cellW/2;
                const cy = pad + i*cellH + cellH/2;
                
                // Draw circle proportional to probability
                const r = Math.sqrt(prob) * 40; // Scale radius
                
                if(r > 0) {
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI*2);
                    
                    // Color based on Rho? No, just heat
                    ctx.fillStyle = `rgba(139, 92, 246, ${0.3 + prob})`;
                    ctx.fill();
                    
                    ctx.fillStyle = "#fff";
                    ctx.textAlign = "center";
                    ctx.font = "12px sans-serif";
                    ctx.fillText(prob.toFixed(2), cx, cy);
                }
            }
        }
        
        // Draw Trend Line hint
        // If Rho > 0, line from top-left to bottom-right (1,2 to 3,5)? 
        // Wait, X=1 is top row, X=3 is bottom row. Y=2 left, Y=5 right.
        // (1,2) -> Top Left. (3,5) -> Bottom Right.
        // So positive correlation is Top-Left + Bottom-Right (Diagonal).
        // Negative is Top-Right (1,5) + Bottom-Left (3,2) (Anti-Diagonal).
        
        ctx.strokeStyle = rho > 0 ? "#10b981" : (rho < 0 ? "#ef4444" : "#9ca3af");
        ctx.lineWidth = 3;
        ctx.globalAlpha = Math.abs(rho); // Fade line if weak corr
        
        if(rho > 0.1) {
            ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();
        } else if (rho < -0.1) {
            ctx.beginPath(); ctx.moveTo(w-pad, pad); ctx.lineTo(pad, h-pad); ctx.stroke();
        }
        ctx.globalAlpha = 1.0;
    }

    // Init
    setLanguage('en');

</script>

</body>
</html>